<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>ç¶²è³¼ä»‹é¢</title>
  <link rel="stylesheet" href="cartstyle.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
<nav class="navbar">
  <div class="nav-inner">

    <a class="logo" href="index.html#home">
      <img src="photo/logo.png" alt="">
      <h2>æŸ¿å­è³¼ç‰©</h2>
    </a>

    <!-- âœ… æ‰‹æ©Ÿæ¼¢å ¡ -->
    <input class="nav-toggle" id="nav-toggle" type="checkbox"/>
    <label aria-label="é–‹å•Ÿé¸å–®" class="burger" for="nav-toggle">
      <span></span><span></span><span></span>
    </label>

    <!-- âœ… ä¸»é¸å–® -->
    <ul class="nav-list">
      <li><a href="index.html#home">å›é¦–é </a></li>
      <li><a href="index.html#event">æœ€æ–°å„ªæƒ </a></li>

      <li class="has-mega">
        <a aria-expanded="false" aria-haspopup="true" class="nav-link" href="index.html#products">
          å…¨éƒ¨å•†å“ <i class="fa-solid fa-angle-down" style="margin-left:6px;"></i>
        </a>

        <div class="mega">
  <div class="mega-inner">

    <div class="mega-col" data-mega-col="types">
      <h4>ä¾ç¨®é¡</h4>
      <div class="mega-links"></div>
    </div>

    <div class="mega-col" data-mega-col="brands">
      <h4>ä¾å“ç‰Œ</h4>
      <div class="mega-links"></div>
    </div>

    <div class="mega-col" data-mega-col="audiences">
      <h4>ä¾å°è±¡</h4>
      <div class="mega-links"></div>
    </div>

    <div class="mega-col is-scroll" data-mega-col="prices">
      <h4>ä¾åƒ¹æ ¼</h4>
      <div class="mega-links"></div>
    </div>

  </div>
</div>
      </li>

    

      <li class="hide-md"><a href="index.html#deal">å„ªæƒ æ¶å…ˆè³¼</a></li>
      <li class="hide-md"><a href="index.html#tribe">æ—ç¾¤é¸è³¼</a></li>
      <li><a href="index.html#contact">è¯çµ¡æˆ‘å€‘</a></li>
    </ul>

    <!-- âœ… å³å´ â‹¯ -->
    <div class="nav-more">
      <input class="more-toggle" id="more-toggle" type="checkbox"/>
      <label aria-label="å±•é–‹æ›´å¤š" class="more-btn" for="more-toggle">â‹¯</label>

      <!-- ğŸ” æœå°‹æŒ‰éˆ• -->
      <button aria-label="é–‹å•Ÿæœå°‹" class="nav-search-btn" id="openSearch" type="button">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>

      <a aria-label="è³¼ç‰©è»Š" class="nav-cart" href="cart.html" id="cartLink">ğŸ›’
        <span class="cart-badge" id="cartBadge">0</span>
      </a>

      <!-- ğŸ‘¤ æœƒå“¡ä¸­å¿ƒ -->
      <a aria-label="æœƒå“¡ä¸­å¿ƒ" class="nav-member" href="member.html">
         <i class="fa-regular fa-user"></i>
      </a>

      <div aria-label="æ›´å¤šé¸å–®" aria-modal="true" class="more-overlay" role="dialog">
        <div class="more-panel">
          <div class="more-head">
            <div class="more-actions">
              <button class="more-chip" id="moreExpandAll" type="button">å…¨éƒ¨å±•é–‹</button>
              <button class="more-chip" id="moreCollapseAll" type="button">å…¨éƒ¨æ”¶åˆ</button>
            </div>
            <label aria-label="é—œé–‰" class="more-close" for="more-toggle">âœ•</label>
          </div>

          <div class="more-body">
          <!-- âœ… æŠ½å±œè£¡çš„ã€Œå®Œæ•´å°è¦½ã€æœƒç”± JS è‡ªå‹•ç”Ÿæˆ -->
          <div class="more-nav" id="moreNav"></div>
          </div>
        </div>
      </div><!-- /.more-overlay -->
    </div><!-- /.nav-more -->
  </div><!-- /.nav-inner -->
</nav>

<!-- radiosï¼ˆé¡å‹ç¯©é¸ï¼‰ -->
<input checked id="f-all" name="filter" type="radio"/>
<input id="f-food" name="filter" type="radio"/>
<input id="f-c3" name="filter" type="radio"/>
<input id="f-cloth" name="filter" type="radio"/>
<input id="f-home" name="filter" type="radio"/>

<div id="app">
  <div class="wrap">
    <div class="panel">
      <h2>æœå°‹</h2>
      <div class="field">
        <label for="kw">é—œéµå­—ï¼ˆæ‰“å­—å³æ™‚ç¯©é¸ï¼‰</label>
        <input autocomplete="off" id="kw" placeholder="ä¾‹å¦‚ï¼šå•†å“Aã€åŠŸèƒ½ã€è€³æ©Ÿ..." type="text"/>
      </div>

      <h2>å•†å“ç¯©é¸</h2>

<div class="filters" id="filters">
  <div class="filters-top">
    <button type="button" class="fbtn" id="clearFilters">æ¸…é™¤ç¯©é¸</button>
    <div class="filters-hint" id="filterHint">æœªå¥—ç”¨åˆ†é¡ç¯©é¸</div>
  </div>

  <div class="selected-tags" id="selectedTags"></div>

  <!-- ç¨®é¡ -->
  <details class="facet" open>
    <summary class="facet-title">
  <span>ç¨®é¡</span>
  <span class="facet-right">
    <span class="facet-count" data-count="types"></span>
    <span class="facet-sub">å¯å¤šé¸</span>
  </span>
</summary>
    <div class="facet-body" id="facetTypes">
      <!-- JS æœƒè‡ªå‹•å¡é¸é … -->
    </div>
  </details>

  <!-- å“ç‰Œ -->
  <details class="facet">
    <summary class="facet-title">
  <span>å“ç‰Œ</span>
  <span class="facet-right">
    <span class="facet-count" data-count="brands"></span>
    <span class="facet-sub">å¯å¤šé¸</span>
  </span>
</summary>
    <div class="facet-body" id="facetBrands">
      <!-- JS æœƒè‡ªå‹•å¡é¸é … -->
    </div>
  </details>

  <!-- å°è±¡ -->
  <details class="facet">
    <summary class="facet-title">
  <span>å°è±¡</span>
  <span class="facet-right">
    <span class="facet-count" data-count="audiences"></span>
    <span class="facet-sub">å¯å¤šé¸</span>
  </span>
</summary>
    <div class="facet-body" id="facetAudiences">
      <!-- JS æœƒè‡ªå‹•å¡é¸é … -->
    </div>
  </details>

  <!-- åƒ¹æ ¼ -->
  <details class="facet">
    <summary class="facet-title">
  <span>åƒ¹æ ¼</span>
  <span class="facet-right">
    <span class="facet-count" data-count="prices"></span>
    <span class="facet-sub">å¯å¤šé¸</span>
  </span>
</summary>
    <div class="facet-body" id="facetPrices">
      <!-- JS æœƒè‡ªå‹•å¡é¸é … -->
    </div>
  </details>
</div>
    </div>

    <div class="content">
      <div class="toolbar">
        <div>
          <h3>å•†å“åˆ—è¡¨</h3>
          <p id="status">ç›®å‰ï¼šå…¨éƒ¨</p>
        </div>
      </div>

      <!-- âœ… æ’åºåˆ— -->
      <div class="sortbar" id="sortbar">
        <button class="sortbtn is-active" data-sort="new">æœ€æ–°ä¸Šæ¶</button>
        <button class="sortbtn" data-sort="hot">ç†±é–€é—œæ³¨</button>
        <button class="sortbtn" data-sort="best">è³£å¾—æœ€å¥½</button>
        <button class="sortbtn" data-sort="low">åƒ¹æ ¼æœ€ä½</button>
        <button class="sortbtn" data-sort="high">åƒ¹æ ¼æœ€é«˜</button>
        <button class="sortbtn sort-sale" data-filter-sale>åªçœ‹ç‰¹åƒ¹</button>
      </div>

      <!-- å•†å“åˆ—è¡¨ -->
      <div class="grid" id="grid">
        <div class="grid-note">å•†å“è¼‰å…¥ä¸­â€¦</div>
      </div>
      <!-- âœ… åˆ†é  -->
      <div class="pager" id="pager"></div>
    </div>
  </div>
</div>



<!-- ===== Cart Drawer ===== -->
<div class="drawer-mask hidden" id="mask"></div>
<aside aria-label="è³¼ç‰©è»Šå…§å®¹" class="drawer hidden" id="drawer">
  <div class="drawer-head">
    <h3>è³¼ç‰©è»Š</h3>
    <button class="drawer-close" id="closeCart">é—œé–‰</button>
  </div>
  <div class="drawer-body" id="cartList"></div>
  <div class="drawer-foot">
    <div class="total-row">
      <div>ç¸½è¨ˆ</div>
      <div id="totalPrice">NT$0</div>
    </div>
    <button class="checkout" id="checkoutBtn">çµå¸³ï¼ˆç¤ºç¯„ï¼‰</button>
  </div>
</aside>

<!-- ===================== æœå°‹è¦–çª—ï¼ˆèˆ‡ index å…±ç”¨ï¼‰ ===================== -->
<div class="search-modal" id="searchModal" aria-hidden="true">
  <div class="search-panel" role="dialog" aria-modal="true">

    <div class="search-head">
      <div class="search-head-title">æœå°‹</div>
      <button class="search-close" id="closeSearch" aria-label="é—œé–‰">âœ•</button>
    </div>

    <div class="search-top">
      <select class="search-select" id="searchType">
        <option value="all">å…¨éƒ¨</option>
        <option value="product">å•†å“</option>
        <option value="brand">å“ç‰Œ</option>
        <option value="tag">é—œéµå­—</option>
      </select>

      <input class="search-input" id="searchInput" type="text" placeholder="æƒ³æ‰¾ä»€éº¼å‘¢ï¼Ÿ" />
      <button class="search-btn" id="searchBtn">æœå°‹</button>
    </div>

    <div class="search-body">
      <div class="search-results" id="searchResults">
        <div class="search-empty">è«‹è¼¸å…¥é—œéµå­—é–‹å§‹æœå°‹</div>
      </div>
    </div>

    <div class="search-hot">
      <div class="hot-title">å¤§å®¶æœ€æ„›æœ</div>
      <div class="hot-tags" id="hotTags">
        <button class="hot-tag" data-q="ç›Šç”ŸèŒ">ç›Šç”ŸèŒ</button>
        <button class="hot-tag" data-q="è‘‰é»ƒç´ ">è‘‰é»ƒç´ </button>
        <button class="hot-tag" data-q="Q10">Q10</button>
        <button class="hot-tag" data-q="Bç¾¤">Bç¾¤</button>
        <button class="hot-tag" data-q="é­šæ²¹">é­šæ²¹</button>
        <button class="hot-tag" data-q="éˆ£é‚">éˆ£é‚</button>
      </div>
    </div>

  </div>
</div>

<!-- ===================== å•†å“å…§å®¹ Modalï¼ˆå®Œæ•´ç‰ˆï¼‰ ===================== -->
<div class="pmodal" id="productModal" aria-hidden="true">
  <div class="pmodal__backdrop" data-close></div>

  <div class="pmodal__panel" role="dialog" aria-modal="true" aria-labelledby="pmodalTitle" tabindex="-1">
    <button class="pmodal__close" type="button" aria-label="é—œé–‰" data-close>âœ•</button>

    <div class="pmodal__grid">
      <!-- å·¦ï¼šç¸®åœ–åˆ— + ä¸»åœ– -->
      <div class="pmodal__media">
        <div class="pthumbs" id="pmodalThumbs" aria-label="å•†å“ç¸®åœ–"></div>

        <div class="pmain">
          <div class="pmain__badges" id="pmodalBadges"></div>
          <img id="pmodalImg" alt="" />
        </div>
      </div>

      <!-- å³ï¼šè³‡è¨Š -->
      <div class="pmodal__info">
        <div class="pmodal__meta">
          <div class="pmodal__brand" id="pmodalBrand"></div>
          <div class="pmodal__tags" id="pmodalTags"></div>
        </div>

        <h2 class="pmodal__title" id="pmodalTitle"></h2>

        <div class="pmodal__price" id="pmodalPrice"></div>

        <!-- âœ… æ´»å‹•æ¨™ç±¤ï¼ˆå¯æœ‰å¯ç„¡ï¼‰ -->
        <div class="ppromos" id="pmodalPromos" style="display:none;"></div>

        <div class="pmodal__desc" id="pmodalDesc"></div>

        <!-- âœ… å®¹é‡/è¦æ ¼ï¼ˆå¯æœ‰å¯ç„¡ï¼‰ -->
        <div class="pvariant" id="pmodalVariants" style="display:none;">
          <div class="pvariant__title">å®¹é‡ / è¦æ ¼</div>
          <div class="pvariant__options" id="pmodalVariantOptions"></div>
        </div>

        <div class="pmodal__actions">
          <label class="pmodal__qty">
            æ•¸é‡
            <input id="pmodalQty" type="number" min="1" value="1" />
          </label>

          <button class="pmodal__add add-cart-btn" type="button" id="pmodalAddBtn" data-add="">
            <i class="fa-solid fa-cart-plus" style="margin-right:6px;"></i>åŠ å…¥è³¼ç‰©è»Š
          </button>
        </div>

        <!-- âœ… åº«å­˜æç¤º -->
        <div class="pstock" id="pmodalStock"></div>

        <div class="pmodal__note" id="pmodalNote"></div>
      </div>
    </div>
  </div>
</div>



<script>
/* âœ… æ¡Œæ©Ÿ mega / æ‰‹æ©Ÿé»æ“Šå±•é–‹ */
(() => {
  const item = document.querySelectorAll('.has-mega');
  const mq = window.matchMedia('(max-width: 900px)');
  item.forEach(it => {
    const link = it.querySelector('a.nav-link');
    if(!link) return;
    link.addEventListener('click', (e) => {
      if(mq.matches){
        e.preventDefault();
        it.classList.toggle('is-open');
      }
    });
  });
})();
</script>

<script>
/* âœ… æ‰‹æ©Ÿé»é¸ä»»ä¸€é€£çµå¾Œï¼šé—œé–‰æ¼¢å ¡é¸å–® */
(() => {
  const navToggle = document.getElementById('nav-toggle');
  if(!navToggle) return;
  document.querySelectorAll('.nav-list a').forEach(a => {
    a.addEventListener('click', () => { navToggle.checked = false; });
  });
})();
</script>

<script>
/* âœ… å±•é–‹æ›´å¤šï¼šé–ä½èƒŒæ™¯æ²å‹•ï¼ˆé¿å…åº•ä¸‹é é¢æ»‘å‹•ï¼‰ */
(() => {
  const toggle = document.getElementById('more-toggle');
  if(!toggle) return;

  let savedY = 0;

  const lockScroll = () => {
    savedY = window.scrollY || document.documentElement.scrollTop || 0;
    document.body.classList.add('is-more-open');
    document.body.style.position = 'fixed';
    document.body.style.top = `-${savedY}px`;
    document.body.style.left = '0';
    document.body.style.right = '0';
    document.body.style.width = '100%';
  };

  const unlockScroll = () => {
    document.body.classList.remove('is-more-open');
    document.body.style.position = '';
    document.body.style.top = '';
    document.body.style.left = '';
    document.body.style.right = '';
    document.body.style.width = '';
    window.scrollTo(0, savedY);
  };

  const sync = () => {
    if(toggle.checked) lockScroll();
    else unlockScroll();
  };

  toggle.addEventListener('change', sync);
  sync();
})();
</script>

<script>
/* âœ… å±•é–‹æ›´å¤šï¼šå…¨éƒ¨å±•é–‹ / å…¨éƒ¨æ”¶åˆ */
(() => {
  const overlay = document.querySelector('.more-overlay');
  const toggle  = document.getElementById('more-toggle');
  if(!overlay || !toggle) return;

  const btnOpenAll  = document.getElementById('moreExpandAll');
  const btnCloseAll = document.getElementById('moreCollapseAll');

  const getAccords = () => Array.from(overlay.querySelectorAll('details.more-acc'));

  const openAll = () => getAccords().forEach(d => d.open = true);
  const closeAll = () => getAccords().forEach(d => d.open = false);

  if(btnOpenAll)  btnOpenAll.addEventListener('click', openAll);
  if(btnCloseAll) btnCloseAll.addEventListener('click', closeAll);

  toggle.addEventListener('change', () => {
    if(toggle.checked){
      closeAll();
      const body = overlay.querySelector('.more-body');
      if(body) body.scrollTop = 0;
    }
  });
})();
</script>

<script src="products_api.js"></script>
<script src="nav_mega_dynamic.js"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const grid   = document.getElementById('grid');
  const kw     = document.getElementById('kw');
  const status = document.getElementById('status');
  const sortbar = document.getElementById('sortbar');
  const pager = document.getElementById('pager');

  if (!grid || !kw || !status || !sortbar || !pager) {
    console.error('âŒ ç¼ºå°‘å¿…è¦å…ƒç´ ï¼š#grid #kw #status #sortbar #pager');
    return;
  }

  // âœ… åˆ¤æ–·æ˜¯å¦ç‚º F5 / Reload
  const nav = performance.getEntriesByType('navigation')[0];
  const isReload = !!(nav && nav.type === 'reload');

  // ===== ç‹€æ…‹ =====
  let allProducts = [];
  let currentSort = 'new';
  let currentType = 'all';
  let currentKw   = '';
  let currentSection = 'all';
  let onlySale = false;

  const PAGE_SIZE = 18;
  let currentPage = 1;

  // ===== å°å·¥å…· =====
  const norm = (s) => (s ?? '').toString().toLowerCase().trim();
  const toTime = (d) => {
    const t = new Date(d).getTime();
    return Number.isFinite(t) ? t : 0;
  };

  // =========================
  // âœ… å››å¤§åˆ†é¡ç¯©é¸ï¼ˆç¨®é¡/å“ç‰Œ/å°è±¡/åƒ¹æ ¼ï¼‰
  // =========================
  const filtersEl = document.getElementById('filters');
  const hintEl = document.getElementById('filterHint');
  const clearBtn = document.getElementById('clearFilters');
  const selectedTagsEl = document.getElementById('selectedTags');
  const facetTypes = document.getElementById('facetTypes');
  const facetBrands = document.getElementById('facetBrands');
  const facetAudiences = document.getElementById('facetAudiences');
  const facetPrices = document.getElementById('facetPrices');

  const TYPE_DICT = {
    food:  { value:'food',  label:'é£Ÿå“',  en:'Food' },
    c3:    { value:'c3',    label:'3C',    en:'Tech' },
    cloth: { value:'cloth', label:'æœé£¾',  en:'Fashion' },
    home:  { value:'home',  label:'å±…å®¶',  en:'Home' },
  };

  const AUD_DICT = {
    pregnant: { value:'pregnant', label:'å­•å©¦' },
    kids:     { value:'kids',     label:'å°å­©' },
    adult:    { value:'adult',    label:'æˆäºº' },
    senior:   { value:'senior',   label:'æ¨‚é½¡' },
  };
  // âœ… ä¾› getOptionLabel / tag é¡¯ç¤ºç”¨ï¼ˆå¿…é ˆå­˜åœ¨ï¼Œå¦å‰‡ types/audiences æœƒ ReferenceErrorï¼‰
let TYPE_OPTIONS = [];
let AUDIENCE_OPTIONS = [];
  // âœ… å¾å•†å“è³‡æ–™å‹•æ…‹æŠ“å‡ºã€Œæœ‰å“ªäº›ç¨®é¡ä»£ç¢¼ã€
const buildTypeOptionsFromProducts = (list) => {
  const s = new Set();
  (list || []).forEach(p => {
    const arr = Array.isArray(p.types) ? p.types : (p.type ? [p.type] : []);
    arr.map(norm).filter(Boolean).forEach(t => s.add(t));
  });

  return Array.from(s)
    .sort((a,b) => a.localeCompare(b, 'zh-Hant'))
    .map(v => TYPE_DICT[v] || { value: v, label: v });
};

// âœ… å¾å•†å“è³‡æ–™å‹•æ…‹æŠ“å‡ºã€Œæœ‰å“ªäº›å°è±¡ä»£ç¢¼ã€
const buildAudienceOptionsFromProducts = (list) => {
  const s = new Set();
  (list || []).forEach(p => {
    const arr = Array.isArray(p.audiences) ? p.audiences : [];
    arr.map(norm).filter(Boolean).forEach(a => s.add(a));
  });

  return Array.from(s)
    .sort((a,b) => a.localeCompare(b, 'zh-Hant'))
    .map(v => AUD_DICT[v] || { value: v, label: v });
};

  const PRICE_OPTIONS = [
    { value: '0-99',     label: '$0â€“99',     min: 0,   max: 99 },
    { value: '100-200',  label: '$100â€“200',  min: 100, max: 200 },
    { value: '201-500',  label: '$201â€“500',  min: 201, max: 500 },
    { value: '501-999',  label: '$501â€“999',  min: 501, max: 999 },
    { value: '1000+',    label: '$1000+',    min: 1000, max: Infinity },
  ];

  // âœ… ç¯©é¸ç‹€æ…‹ï¼ˆå¤šé¸ï¼‰
  // types/audiences ç”¨å°å¯«å­˜ï¼›brands ç”¨åŸå­—ä¸²å­˜ï¼›prices ç”¨ value åŸæ¨£å­˜
  const selected = {
    types: new Set(),
    brands: new Set(),
    audiences: new Set(),
    prices: new Set(),
  };

  const renderFacetChips = (wrap, items, name) => {
    if (!wrap) return;
    wrap.innerHTML = items.map(it => `
      <label class="fchip" data-chip data-name="${name}" data-value="${it.value}">
        <input type="checkbox" data-name="${name}" value="${it.value}">
        <span>${it.label}${it.en ? ` <small>${it.en}</small>` : ''}</span>
      </label>
    `).join('');
  };

  const buildBrandOptionsFromProducts = (list) => {
    const s = new Set();
    (list || []).forEach(p => {
      const b = (p.brand || '').trim() || 'å…¶ä»–';
      s.add(b);
    });
    return Array.from(s).sort((a,b) => a.localeCompare(b, 'zh-Hant'));
  };

  const renderBrands = (brands) => {
    if (!facetBrands) return;
    facetBrands.innerHTML = brands.map(b => `
      <label class="fchip" data-chip data-name="brands" data-value="${b}">
        <input type="checkbox" data-name="brands" value="${b}">
        <span>${b}</span>
      </label>
    `).join('');
  };

  const syncChipActive = () => {
    document.querySelectorAll('[data-chip]').forEach(chip => {
      const name = chip.dataset.name;
      const value = chip.dataset.value;

      let on = false;
      if (name === 'types' || name === 'audiences') {
        on = selected[name].has(String(value).toLowerCase());
      } else {
        on = selected[name].has(value);
      }

      chip.classList.toggle('is-active', !!on);

      const input = chip.querySelector('input[type="checkbox"]');
      if (input) input.checked = !!on;
    });
  };

  const updateHint = () => {
    const parts = [];
    if (selected.types.size) parts.push(`ç¨®é¡ï¼š${[...selected.types].join('ã€')}`);
    if (selected.brands.size) parts.push(`å“ç‰Œï¼š${[...selected.brands].join('ã€')}`);
    if (selected.audiences.size) parts.push(`å°è±¡ï¼š${[...selected.audiences].join('ã€')}`);
    if (selected.prices.size) parts.push(`åƒ¹æ ¼ï¼š${[...selected.prices].join('ã€')}`);

    hintEl.textContent = parts.length ? parts.join(' / ') : 'æœªå¥—ç”¨åˆ†é¡ç¯©é¸';
  };

  const getOptionLabel = (group, value) => {
    if (group === 'brands') return value;

    const findIn = (arr) => (arr || []).find(x => String(x.value) === String(value));
    if (group === 'types') {
      const o = findIn(TYPE_OPTIONS);
      return o ? `${o.label}${o.en ? ` ${o.en}` : ''}` : value;
    }
    if (group === 'audiences') {
      const o = findIn(AUDIENCE_OPTIONS);
      return o ? o.label : value;
    }
    if (group === 'prices') {
      const o = findIn(PRICE_OPTIONS);
      return o ? o.label : value;
    }
    return value;
  };

  const groupNameZh = (group) => ({
    types: 'ç¨®é¡',
    brands: 'å“ç‰Œ',
    audiences: 'å°è±¡',
    prices: 'åƒ¹æ ¼'
  }[group] || group);

  const updateCounts = () => {
    document.querySelectorAll('.facet-count[data-count]').forEach(el => {
      const key = el.dataset.count;
      const n = selected?.[key]?.size || 0;
      if (n > 0) {
        el.style.display = 'inline-flex';
        el.textContent = `å·²é¸ ${n}`;
      } else {
        el.style.display = 'none';
        el.textContent = '';
      }
    });
  };

  const renderSelectedTags = () => {
    if (!selectedTagsEl) return;

    const groups = ['types', 'brands', 'audiences', 'prices'];
    const tags = [];

    groups.forEach(g => {
      const set = selected[g];
      if (!set || !set.size) return;

      [...set].forEach(val => {
        tags.push({
          group: g,
          value: val,
          label: getOptionLabel(g, val),
          groupZh: groupNameZh(g),
        });
      });
    });

    if (!tags.length) {
      selectedTagsEl.innerHTML = '';
      return;
    }

    selectedTagsEl.innerHTML = tags.map(t => `
      <div class="stag" data-tag data-name="${t.group}" data-value="${t.value}">
        <span class="k">${t.groupZh}</span>
        <span class="v">${t.label}</span>
        <button type="button" class="x" aria-label="ç§»é™¤">âœ•</button>
      </div>
    `).join('');
  };

  const updateAllFacetsUI = () => {
    syncChipActive();
    updateHint();
    updateCounts();
    renderSelectedTags();
  };

  const playRipple = (chip, ev) => {
    if (!chip) return;

    chip.classList.add('is-press');
    setTimeout(() => chip.classList.remove('is-press'), 120);

    const old = chip.querySelector('.ripple');
    if (old) old.remove();

    const r = document.createElement('span');
    r.className = 'ripple';

    const rect = chip.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    r.style.width = r.style.height = size + 'px';

    const x = (ev?.clientX ?? (rect.left + rect.width / 2)) - rect.left - size / 2;
    const y = (ev?.clientY ?? (rect.top + rect.height / 2)) - rect.top - size / 2;
    r.style.left = x + 'px';
    r.style.top = y + 'px';

    chip.appendChild(r);
    r.addEventListener('animationend', () => r.remove(), { once: true });
  };

  const clearAllFilters = () => {
    selected.types.clear();
    selected.brands.clear();
    selected.audiences.clear();
    selected.prices.clear();

    updateAllFacetsUI();
    currentPage = 1;
    render();
  };

  clearBtn?.addEventListener('click', clearAllFilters);

  // âœ… é»é¸ chipï¼ˆæ•´æ ¼éƒ½å¯é»ï¼‰
  filtersEl?.addEventListener('click', (e) => {
    const chip = e.target.closest('[data-chip]');
    if (!chip) return;

    e.preventDefault();
    playRipple(chip, e);

    const name = chip.dataset.name;
    const value = chip.dataset.value;
    if (!name) return;

    const set = selected[name];
    if (!set) return;

    // âœ… types/audiences å°å¯«å­˜ï¼›brands åŸæ¨£ï¼›prices åŸæ¨£
    const v = (name === 'types' || name === 'audiences')
      ? String(value).toLowerCase()
      : String(value);

    if (set.has(v)) set.delete(v);
    else set.add(v);

    updateAllFacetsUI();
    currentPage = 1;
    render();
  });

  // âœ… é»é¸ä¸Šæ–¹ tag çš„ âœ• ç§»é™¤
  selectedTagsEl?.addEventListener('click', (e) => {
    const btn = e.target.closest('.x');
    if (!btn) return;

    const tag = e.target.closest('[data-tag]');
    if (!tag) return;

    const name = tag.dataset.name;
    const value = tag.dataset.value;

    const set = selected[name];
    if (!set) return;

    set.delete(value);

    updateAllFacetsUI();
    currentPage = 1;
    render();
  });

  // ===== ç¯©é¸æ¯”å° =====
  const matchTypesMulti = (p) => {
    if (!selected.types.size) return true;
    const types = Array.isArray(p.types) ? p.types : (p.type ? [p.type] : []);
    return types.map(norm).some(t => selected.types.has(t));
  };

  const matchBrandsMulti = (p) => {
    if (!selected.brands.size) return true;
    const b = (p.brand || '').trim() || 'å…¶ä»–';
    return selected.brands.has(b);
  };

  const matchAudiencesMulti = (p) => {
    if (!selected.audiences.size) return true;
    const aud = Array.isArray(p.audiences) ? p.audiences : [];
    const audNorm = aud.map(norm);
    return audNorm.some(a => selected.audiences.has(a));
  };
  const effectivePrice = (p) => {
  const base = (p.originalPrice ?? p.price);
  const sale = p.salePrice;

  // 1) æœ€å¤–å±¤æœ‰ sale / price
  if (sale != null && base != null && Number(sale) < Number(base)) return Number(sale);
  if (base != null) return Number(base);

  // 2) æ²’æœ‰æœ€å¤–å±¤åƒ¹æ ¼ â†’ ç”¨ variants æœ€ä½åƒ¹
  const vs = Array.isArray(p.variants) ? p.variants : [];
  const prices = vs
    .map(v => v?.salePrice ?? v?.originalPrice ?? v?.price)
    .map(Number)
    .filter(n => Number.isFinite(n));

  if (prices.length) return Math.min(...prices);

  return Infinity;
  };
  const isOnSale = (p) => {
  const baseTop = (p.originalPrice ?? p.price);
  const saleTop = p.salePrice;

  // å•†å“æœ¬èº«ç‰¹åƒ¹
  if (saleTop != null && baseTop != null && Number(saleTop) < Number(baseTop)) {
    return true;
  }

  // ä»»ä¸€è¦æ ¼ç‰¹åƒ¹
  const vs = Array.isArray(p.variants) ? p.variants : [];
  return vs.some(v => {
    const base = (v?.originalPrice ?? v?.price);
    const sale = v?.salePrice;
    return sale != null && base != null && Number(sale) < Number(base);
  });
};

  const matchPricesMulti = (p) => {
    if (!selected.prices.size) return true;

    const price = effectivePrice(p);
    return PRICE_OPTIONS
      .filter(r => selected.prices.has(r.value))
      .some(r => price >= r.min && price <= r.max);
  };

  const matchKw = (p, kwText) => {
    if (!kwText) return true;
    const k = norm(kwText);

    const hay = [
      p.name,
      p.desc,
      (p.tags || []).join(' '),
      p.brand
    ].map(norm).join(' ');

    return hay.includes(k);
  };

  const matchSection = (p, section) => {
    if (section === 'all') return true;
    return p.section === section;
  };

  const applyQueryFromURL = () => {
    const sp = new URLSearchParams(location.search);
    const q = (sp.get('kw') || sp.get('q') || '').trim();

    if (q) {
      kw.value = q;
      currentKw = q;
      currentPage = 1;
    }
  };

  // âœ… é reload æ‰å¥—ç”¨ç¶²å€æœå°‹ï¼›F5 å°±æ¸…åƒæ•¸
  if (!isReload) {
    applyQueryFromURL();
  } else {
    history.replaceState(null, '', location.pathname);
  }

  const sortList = (list, key) => {
    const arr = [...list];
    switch (key) {
      case 'new':  return arr.sort((a,b) => toTime(b.createdAt) - toTime(a.createdAt));
      case 'hot':  return arr.sort((a,b) => (b.views||0) - (a.views||0));
      case 'best': return arr.sort((a,b) => (b.sales||0) - (a.sales||0));
      case 'low':  return arr.sort((a,b) => effectivePrice(a) - effectivePrice(b));
      case 'high': return arr.sort((a,b) => effectivePrice(b) - effectivePrice(a));
      default:     return arr;
    }
  };

  const fmt = (n) => n == null ? '' : '$' + Number(n).toLocaleString('zh-Hant-TW');

  // ===== âœ… å…ˆå®£å‘Š renderï¼Œå†ç¶äº‹ä»¶/ fetchï¼ˆé¿å… hoist å•é¡Œï¼‰=====
  const render = () => {
    const filtered = allProducts
      .filter(p => matchSection(p, currentSection))
      .filter(p => matchTypesMulti(p))
      .filter(p => matchBrandsMulti(p))
      .filter(p => matchAudiencesMulti(p))
      .filter(p => matchPricesMulti(p))
      .filter(p => matchKw(p, currentKw))
      .filter(p => !onlySale || isOnSale(p));

    const sorted = sortList(filtered, currentSort);

    const total = sorted.length;
    const totalPages = Math.max(1, Math.ceil(total / PAGE_SIZE));
    currentPage = Math.min(currentPage, totalPages);

    const start = (currentPage - 1) * PAGE_SIZE;
    const end = start + PAGE_SIZE;
    const pageItems = sorted.slice(start, end);

    status.textContent = `ç›®å‰ï¼š${total} ä»¶ / ç¬¬ ${currentPage} é ï¼Œå…± ${totalPages} é `;

    if (!total) {
      grid.innerHTML = `<div class="grid-note">æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„å•†å“</div>`;
      pager.innerHTML = '';
      return;
    }
    grid.innerHTML = pageItems.map(p => {
  const vs = Array.isArray(p.variants) ? p.variants : [];

  const baseTop = (p.originalPrice ?? p.price);
  const saleTop = p.salePrice;

  const hasSale =
  // 1) æœ€å¤–å±¤ç‰¹åƒ¹
  (saleTop != null && baseTop != null && Number(saleTop) < Number(baseTop))
  // 2) æˆ– variants ä»»ä¸€è¦æ ¼æœ‰ç‰¹åƒ¹
  || vs.some(v => {
       const base = v?.originalPrice ?? v?.price;
       const sale = v?.salePrice;
       return (sale != null && base != null && Number(sale) < Number(base));
     });

  let priceHtml = '';

  if (baseTop != null) {
    const original = baseTop;
    const sale = saleTop;

    priceHtml = hasSale
      ? `<div class="pprice pprice-sale">
           <span class="sale">${fmt(sale)}</span>
           <span class="orig">${fmt(original)}</span>
         </div>`
      : `<div class="pprice pprice-normal">${fmt(original)}</div>`;
  } else if (vs.length) {
  const baseList = vs
    .map(v => v?.originalPrice ?? v?.price)
    .map(Number)
    .filter(n => Number.isFinite(n));

  const saleList = vs
    .map(v => v?.salePrice)
    .map(Number)
    .filter(n => Number.isFinite(n));

  const hasAnySale = vs.some(v => {
    const base = v?.originalPrice ?? v?.price;
    const sale = v?.salePrice;
    return sale != null && base != null && Number(sale) < Number(base);
  });

  const minBase = baseList.length ? Math.min(...baseList) : null;
  const maxBase = baseList.length ? Math.max(...baseList) : null;

  // âœ… ç‰¹åƒ¹ç”¨ã€Œæœ‰ sale å°±ç”¨ saleï¼Œæ²’ sale å°±ç”¨ baseã€å»ç®—å¯¦ä»˜å€é–“
  const payList = vs
    .map(v => {
      const base = v?.originalPrice ?? v?.price;
      const sale = v?.salePrice;
      const pay = (sale != null && base != null && Number(sale) < Number(base)) ? sale : base;
      return Number(pay);
    })
    .filter(n => Number.isFinite(n));

  const minPay = payList.length ? Math.min(...payList) : null;
  const maxPay = payList.length ? Math.max(...payList) : null;

  const payText =
    (minPay != null && maxPay != null)
      ? (minPay === maxPay ? fmt(minPay) : `${fmt(minPay)} â€“ ${fmt(maxPay)}`)
      : 'åƒ¹æ ¼æœªæä¾›';

  if (hasAnySale && minBase != null && maxBase != null) {
    const baseText = (minBase === maxBase) ? fmt(minBase) : `${fmt(minBase)} â€“ ${fmt(maxBase)}`;
    priceHtml = `
      <div class="pprice pprice-sale">
        <span class="sale">${payText}</span>
        <span class="orig">${baseText}</span>
      </div>
    `;
  } else {
    priceHtml = `<div class="pprice pprice-normal">${payText}</div>`;
  }
}

  return `
    <div class="card" data-id="${p.id}">
      <div class="thumb">
        ${hasSale ? `<span class="sale-badge">ç‰¹åƒ¹</span>` : ``}
        <img src="${p.image}" alt="${p.name}">
      </div>

      <h4 class="name">${p.name}</h4>
      <p class="desc">${p.desc || ''}</p>

      <div class="card-bottom">
        ${priceHtml}
        <button class="btn-add add-cart-btn" type="button" data-add="${p.id}">
          <i class="fa-solid fa-cart-plus" style="margin-right:6px;"></i>åŠ å…¥è³¼ç‰©è»Š
        </button>
      </div>
    </div>
  `;
}).join('');




    const makeBtn = (label, page, disabled = false, active = false) =>
      `<button class="pbtn ${active ? 'is-active' : ''}" data-page="${page}" ${disabled ? 'disabled' : ''}>${label}</button>`;

    let html = '';
    html += makeBtn('â€¹ ä¸Šä¸€é ', currentPage - 1, currentPage === 1);

    for (let p = 1; p <= totalPages; p++) {
      html += makeBtn(String(p), p, false, p === currentPage);
    }

    html += makeBtn('ä¸‹ä¸€é  â€º', currentPage + 1, currentPage === totalPages);
    pager.innerHTML = html;
  };

  // ===== äº‹ä»¶ï¼šé—œéµå­— =====
  kw.addEventListener('input', () => {
    currentKw = kw.value;
    currentPage = 1;
    render();
  });

  // ===== äº‹ä»¶ï¼šåˆ†é  =====
  pager.addEventListener('click', (e) => {
    const btn = e.target.closest('.pbtn');
    if (!btn) return;

    const p = Number(btn.dataset.page);
    if (!Number.isFinite(p)) return;

    currentPage = p;
    render();
    grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
  });

  // ===== äº‹ä»¶ï¼šæ’åº =====
  sortbar.addEventListener('click', (e) => {
    const btn = e.target.closest('[data-sort]');
    if (!btn) return;

    currentSort = btn.dataset.sort;
    currentPage = 1;

    sortbar.querySelectorAll('.sortbtn').forEach(b => b.classList.remove('is-active'));
    btn.classList.add('is-active');

    render();
  });

  // ===== äº‹ä»¶ï¼šåªçœ‹ç‰¹åƒ¹ =====
  const saleBtn = sortbar.querySelector('[data-filter-sale]');
  if (saleBtn) {
    saleBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      onlySale = !onlySale;
      currentPage = 1;
      saleBtn.classList.toggle('is-active', onlySale);
      render();
    });
  }

  // ===== è®€ products APIï¼ˆå–ä»£ products.jsonï¼‰=====
  window.ProductAPI.getProducts({ force: true })
  .then(data => {
    console.log("âœ… API items length =", Array.isArray(data) ? data.length : data);
    allProducts = Array.isArray(data) ? data : [];
    console.log('âœ… products API loaded:', allProducts.length);

    const typeOptions = buildTypeOptionsFromProducts(allProducts);
    const audOptions  = buildAudienceOptionsFromProducts(allProducts);

    TYPE_OPTIONS = typeOptions;
    AUDIENCE_OPTIONS = audOptions;

    renderFacetChips(facetTypes, typeOptions, 'types');
    renderFacetChips(facetAudiences, audOptions, 'audiences');
    renderFacetChips(facetPrices, PRICE_OPTIONS, 'prices'); // åƒ¹æ ¼é€šå¸¸å›ºå®šå°±å¥½
    renderBrands(buildBrandOptionsFromProducts(allProducts));

    // âœ… F5 / Reloadï¼šæ¸…ç©ºæœå°‹ & æ¸…ç©ºç¯©é¸ & æ¸…æ‰åªçœ‹ç‰¹åƒ¹ï¼ˆæ­¤æ™‚è³‡æ–™å·²è¼‰å…¥ï¼ŒUI å®‰å…¨ï¼‰
    if (isReload) {
      kw.value = '';
      currentKw = '';

      selected.types.clear();
      selected.brands.clear();
      selected.audiences.clear();
      selected.prices.clear();

      onlySale = false;
      sortbar.querySelector('[data-filter-sale]')?.classList.remove('is-active');

      currentPage = 1;

      // âœ… æ¸…æ‰ç¶²å€åƒæ•¸
      history.replaceState(null, '', location.pathname);
    }

    // âœ… çµ¦ modal / å…¶ä»– script ç”¨
    window.__ALL_PRODUCTS__ = allProducts;

    updateAllFacetsUI();
    render();
  })
  .catch(err => {
    console.error('âŒ products API è®€å–å¤±æ•—:', err);
    grid.innerHTML = `<div class="grid-note">å•†å“ API è®€å–å¤±æ•—ï¼š${err.message}</div>`;
    pager.innerHTML = '';
  });
});
</script>

<script>
(() => {
  const grid  = document.getElementById('grid');
  const modal = document.getElementById('productModal');
  if (!grid || !modal) return;

  const panel = modal.querySelector('.pmodal__panel');

  const $img    = document.getElementById('pmodalImg');
  const $thumbs = document.getElementById('pmodalThumbs');
  const $badges = document.getElementById('pmodalBadges');

  const $brand  = document.getElementById('pmodalBrand');
  const $tags   = document.getElementById('pmodalTags');
  const $title  = document.getElementById('pmodalTitle');
  const $price  = document.getElementById('pmodalPrice');
  const $desc   = document.getElementById('pmodalDesc');

  const $promosWrap = document.getElementById('pmodalPromos');

  const $variantsWrap = document.getElementById('pmodalVariants');
  const $variantOps   = document.getElementById('pmodalVariantOptions');

  const $qty   = document.getElementById('pmodalQty');
  const $add   = document.getElementById('pmodalAddBtn');
  const $stock = document.getElementById('pmodalStock');
  const $note  = document.getElementById('pmodalNote');

  const getAll = () => window.__ALL_PRODUCTS__ || [];

  const fmt = (n) => 'NT$' + Number(n).toLocaleString('zh-Hant-TW');

  // ===== åƒ¹æ ¼ï¼ˆæ”¯æ´ sale/original æˆ– variantï¼‰=====
  const basePriceOf = (p) => (p.originalPrice ?? p.price ?? 0);
  const salePriceOf = (p) => (p.salePrice ?? null);

  const hasSaleOf = (p, base, sale) => {
    const b = Number(base);
    const s = sale == null ? null : Number(sale);
    return (s != null && Number.isFinite(s) && Number.isFinite(b) && s < b);
  };

  // ===== è®Šé«”çµæ§‹ï¼ˆä½ å¯ä»¥ç”¨ variantsï¼š[{label:'40ml', price:70, salePrice:65, stock: 12, image:'', images:[]}, ...]ï¼‰=====
  const getVariants = (p) => Array.isArray(p.variants) ? p.variants : [];

  // ===== åœ–ç‰‡é™£åˆ—ï¼ˆå„ªå…ˆ variant.images -> p.images -> å–®å¼µ p.imageï¼‰=====
  const getImages = (p, chosenVariant) => {
    const vImgs = chosenVariant?.images;
    if (Array.isArray(vImgs) && vImgs.length) return vImgs;

    const pImgs = p.images;
    if (Array.isArray(pImgs) && pImgs.length) return pImgs;

    if (p.image) return [p.image];
    return [];
  };

  // ===== æ´»å‹•æ¨™ç±¤ï¼ˆpromos: ['é™æ™‚8æŠ˜','è²·1é€1']ï¼‰=====
  const getPromos = (p) => Array.isArray(p.promos) ? p.promos : [];

  // ===== è§’æ¨™ badgeï¼ˆbadges: ['ç‰¹åƒ¹','ç†±è³£']ï¼‰ï¼›è‹¥æœ‰ sale ä¹Ÿæœƒè‡ªå‹•åŠ ã€Œç‰¹åƒ¹ã€=====
  const getBadges = (p, hasSale, chosenVariant) => {
    const a = new Set();
    (Array.isArray(p.badges) ? p.badges : []).forEach(x => x && a.add(String(x)));

    (Array.isArray(chosenVariant?.badges) ? chosenVariant.badges : []).forEach(x => x && a.add(String(x)));

    if (hasSale) a.add('ç‰¹åƒ¹');
    return [...a];
  };

  // ===== åº«å­˜ï¼ˆæ”¯æ´ p.stock æˆ– variant.stockï¼›æ²’å¡«å°±ä¸é¡¯ç¤ºï¼‰=====
  const getStock = (p, chosenVariant) => {
    const v = chosenVariant?.stock;
    if (v === 0) return 0;
    if (Number.isFinite(Number(v))) return Number(v);

    const s = p.stock;
    if (s === 0) return 0;
    if (Number.isFinite(Number(s))) return Number(s);

    return null; // æœªæä¾›åº«å­˜
  };

  const openModal = () => {
    modal.classList.add('is-open');
    modal.setAttribute('aria-hidden', 'false');
    document.body.classList.add('is-pmodal-open');
    requestAnimationFrame(() => panel?.focus?.());
  };

  const closeModal = () => {
    modal.classList.remove('is-open');
    modal.setAttribute('aria-hidden', 'true');
    document.body.classList.remove('is-pmodal-open');

    const sp = new URLSearchParams(location.search);
    if (sp.has('pid')) {
      sp.delete('pid');
      const qs = sp.toString();
      history.replaceState(null, '', qs ? `${location.pathname}?${qs}` : location.pathname);
    }
  };

  // ===== UIï¼šç¸®åœ– =====
  const renderThumbs = (imgs, activeIdx = 0) => {
    if (!$thumbs) return;
    if (!imgs || !imgs.length) {
      $thumbs.innerHTML = '';
      $thumbs.style.display = 'none';
      return;
    }
    $thumbs.style.display = '';
    $thumbs.innerHTML = imgs.map((src, i) => `
      <button class="pthumb ${i === activeIdx ? 'is-active' : ''}" type="button" data-i="${i}" aria-label="åˆ‡æ›åœ–ç‰‡ ${i+1}">
        <img src="${src}" alt="">
      </button>
    `).join('');
  };

  const setMainImage = (imgs, idx) => {
    const safe = Math.max(0, Math.min(idx, (imgs?.length || 1) - 1));
    const src = imgs?.[safe] || '';
    $img.src = src;
    // åŒæ­¥ active
    $thumbs?.querySelectorAll('.pthumb').forEach(btn => {
      btn.classList.toggle('is-active', Number(btn.dataset.i) === safe);
    });
  };

  // ===== UIï¼špromos / badges / stock =====
  const renderPromos = (promos) => {
    if (!$promosWrap) return;
    if (!promos.length) {
      $promosWrap.style.display = 'none';
      $promosWrap.innerHTML = '';
      return;
    }
    $promosWrap.style.display = '';
    $promosWrap.innerHTML = promos.map(t => `<span class="ppromo">${t}</span>`).join('');
  };

  const renderBadges = (badges) => {
    if (!$badges) return;
    if (!badges.length) {
      $badges.innerHTML = '';
      return;
    }
    $badges.innerHTML = badges.map(b => `<span class="pbadge">${b}</span>`).join('');
  };

  const renderStock = (stock) => {
    // stock: null è¡¨ç¤ºä¸é¡¯ç¤º
    if (stock == null) {
      $stock.textContent = '';
      $stock.classList.remove('is-low', 'is-out');
      return;
    }
    if (stock <= 0) {
      $stock.textContent = 'ç¼ºè²¨ä¸­';
      $stock.classList.add('is-out');
      $stock.classList.remove('is-low');
    } else if (stock <= 5) {
      $stock.textContent = `åº«å­˜ç·Šå¼µï¼šå‰© ${stock} ä»¶`;
      $stock.classList.add('is-low');
      $stock.classList.remove('is-out');
    } else {
      $stock.textContent = `åº«å­˜ï¼š${stock} ä»¶`;
      $stock.classList.remove('is-low', 'is-out');
    }
  };

  const setAddEnabled = (enabled) => {
    $add.disabled = !enabled;
    $add.classList.toggle('is-disabled', !enabled);
  };

  // ===== UIï¼švariant =====
  const renderVariants = (p, variants, selectedIndex) => {
    if (!$variantsWrap || !$variantOps) return;

    if (!variants.length) {
      $variantsWrap.style.display = 'none';
      $variantOps.innerHTML = '';
      return;
    }

    $variantsWrap.style.display = '';
    $variantOps.innerHTML = variants.map((v, i) => {
      const label = v.label || v.name || `è¦æ ¼${i+1}`;
      return `
        <label class="popt">
          <input type="radio" name="pvariant" value="${i}" ${i === selectedIndex ? 'checked' : ''}>
          <span>${label}</span>
        </label>
      `;
    }).join('');
  };

  // ===== æ ¸å¿ƒï¼šæŠŠå•†å“å¡é€² modal =====
  let currentProduct = null;
  let currentVariantIndex = 0;
  let currentImages = [];
  let currentImageIndex = 0;

  const updatePriceAndStock = () => {
    const p = currentProduct;
    if (!p) return;

    const variants = getVariants(p);
    const v = variants.length ? variants[currentVariantIndex] : null;

    // å–åƒ¹ï¼ˆvariant å„ªå…ˆï¼‰
    const base = (v?.originalPrice ?? v?.price ?? basePriceOf(p));
    const sale = (v?.salePrice ?? salePriceOf(p));

    const hasSale = hasSaleOf(p, base, sale);

    $price.innerHTML = hasSale
      ? `<span class="pprice-sale">${fmt(sale)}</span><span class="pprice-orig">${fmt(base)}</span>`
      : `<span class="pprice-normal">${fmt(base)}</span>`;

    // badges
    renderBadges(getBadges(p, hasSale, v));

    // stock + add btn
    const stock = getStock(p, v);
    renderStock(stock);

    if (stock != null && stock <= 0) {
      setAddEnabled(false);
      $note.textContent = 'æ­¤å•†å“ç›®å‰ç¼ºè²¨ï¼Œè«‹ç¨å¾Œå†è©¦';
    } else {
      setAddEnabled(true);
      $note.textContent = '';
    }

    // æŠŠ variant è³‡è¨Šå¡åˆ°æŒ‰éˆ• datasetï¼ˆçµ¦ä½  cart_store.js è‹¥æœªä¾†è¦ç”¨ï¼‰
    $add.dataset.add = p.id;
    $add.dataset.variant = variants.length ? String(currentVariantIndex) : '';
    $add.dataset.vlabel = variants.length ? String(v?.label || v?.name || '') : '';
  };

  const updateImages = () => {
    const p = currentProduct;
    if (!p) return;

    const variants = getVariants(p);
    const v = variants.length ? variants[currentVariantIndex] : null;

    currentImages = getImages(p, v);
    currentImageIndex = 0;

    renderThumbs(currentImages, currentImageIndex);
    setMainImage(currentImages, currentImageIndex);
  };

  const fillModal = (p) => {
    currentProduct = p;
    currentVariantIndex = 0;

    $title.textContent = p.name || '';
    $desc.textContent = p.desc || 'ï¼ˆæ­¤å•†å“å°šæœªå¡«å¯«ä»‹ç´¹ï¼‰';

    const b = (p.brand || '').trim();
    $brand.textContent = b ? b : 'å…¶ä»–';

    const tags = Array.isArray(p.tags) ? p.tags : [];
    $tags.innerHTML = tags.map(t => `<span class="ptag">${t}</span>`).join('');

    // promos
    renderPromos(getPromos(p));

    // variants
    const variants = getVariants(p);
    renderVariants(p, variants, currentVariantIndex);

    // qty reset
    $qty.value = 1;
    $add.dataset.qty = '1';

    // images + price + stock
    updateImages();
    updatePriceAndStock();
  };

  const openById = (id) => {
    const p = getAll().find(x => x.id === id);
    if (!p) return;

    fillModal(p);
    openModal();

    const sp = new URLSearchParams(location.search);
    sp.set('pid', id);
    history.replaceState(null, '', `${location.pathname}?${sp.toString()}`);
  };

  // ===== äº‹ä»¶ï¼šé»å¡ç‰‡é–‹ modal =====
  grid.addEventListener('click', (e) => {
    if (e.target.closest('[data-add]')) return; // é»åŠ å…¥è³¼ç‰©è»Šä¸é–‹ modal
    const card = e.target.closest('.card[data-id]');
    if (!card) return;
    openById(card.dataset.id);
  });

  // ===== äº‹ä»¶ï¼šç¸®åœ–åˆ‡æ› =====
  $thumbs?.addEventListener('click', (e) => {
    const btn = e.target.closest('.pthumb');
    if (!btn) return;
    const i = Number(btn.dataset.i);
    if (!Number.isFinite(i)) return;
    setMainImage(currentImages, i);
  });

  // ===== äº‹ä»¶ï¼švariants åˆ‡æ› =====
  $variantOps?.addEventListener('change', (e) => {
    const input = e.target.closest('input[type="radio"][name="pvariant"]');
    if (!input) return;
    const idx = Number(input.value);
    if (!Number.isFinite(idx)) return;

    currentVariantIndex = idx;
    updateImages();
    updatePriceAndStock();
  });

  // ===== é—œé–‰ =====
  modal.addEventListener('click', (e) => {
    if (e.target.closest('[data-close]')) closeModal();
  });

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && modal.classList.contains('is-open')) closeModal();
  });

  // ===== qty åŒæ­¥ =====
  $qty.addEventListener('input', () => {
    const n = Math.max(1, Number($qty.value || 1));
    $qty.value = n;
    $add.dataset.qty = String(n);
  });

  // âœ… é»åŠ å…¥è³¼ç‰©è»Šå¾Œé—œ modalï¼ˆä¸å½±éŸ¿ä½ çš„ cart_store.jsï¼‰
  $add.addEventListener('click', () => closeModal());

  // ===== æ”¯æ´ ?pid=F001 ç›´æ¥é–‹ =====
  const sp = new URLSearchParams(location.search);
  const pid = sp.get('pid');
  if (pid) {
    const timer = setInterval(() => {
      if (getAll().length) {
        clearInterval(timer);
        openById(pid);
      }
    }, 60);
    setTimeout(() => clearInterval(timer), 5000);
  }
})();
</script>

<script>
(() => {
  const body = document.body;
  const megas = document.querySelectorAll('.has-mega');

  let openCount = 0;

  const openMega = () => {
    openCount++;
    body.classList.add('is-mega-open');
  };

  const closeMega = () => {
    openCount = Math.max(0, openCount - 1);
    if(openCount === 0){
      body.classList.remove('is-mega-open');
    }
  };

  megas.forEach(item => {
    const mega = item.querySelector('.mega');
    if(!mega) return;

    item.addEventListener('mouseenter', openMega);
    item.addEventListener('mouseleave', closeMega);

    item.addEventListener('focusin', openMega);
    item.addEventListener('focusout', closeMega);
  });
})();
</script>
<script>
/* âœ… cart.html æœå°‹è¦–çª—ä¿®å¾©ï¼šæŠŠ modal æœå°‹å°åˆ°å·¦å´å³æ™‚ç¯©é¸ #kw */
(() => {
  const modal = document.getElementById('searchModal');
  const openBtn = document.getElementById('openSearch');
  const closeBtn = document.getElementById('closeSearch');

  const input = document.getElementById('searchInput');
  const typeSel = document.getElementById('searchType');
  const btn = document.getElementById('searchBtn');
  const hotWrap = document.getElementById('hotTags');

  const kw = document.getElementById('kw'); // âœ… ä½ å·¦å´å³æ™‚ç¯©é¸ input

  if (!modal || !openBtn || !closeBtn || !input || !btn || !kw) {
    console.warn('search modal missing required elements');
    return;
  }

  const open = () => {
    modal.classList.add('is-open');
    document.body.classList.add('is-search-open');
    requestAnimationFrame(() => input.focus());
  };

  const close = () => {
    modal.classList.remove('is-open');
    document.body.classList.remove('is-search-open');
  };

  const doSearch = (q) => {
    const query = (q ?? input.value ?? '').trim();
    if (!query) return;

    // âœ… 1) å°åˆ°å·¦å´å³æ™‚ç¯©é¸
    kw.value = query;
    kw.dispatchEvent(new Event('input', { bubbles: true })); // è§¸ç™¼ä½ åŸæœ¬çš„ render()

    // âœ… 2) (å¯é¸) æŠŠæ¢ä»¶å¯«å›ç¶²å€ï¼Œé‡æ•´ä¸æœƒä¸è¦‹
    const sp = new URLSearchParams(location.search);
    sp.set('q', query);
    sp.set('type', (typeSel?.value || 'all'));
    history.replaceState(null, '', `${location.pathname}?${sp.toString()}`);

    // âœ… 3) é—œé–‰ modal
    close();

    // âœ… 4) æ²åˆ°å•†å“å€ï¼ˆå¯é¸ï¼‰
    document.getElementById('grid')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
  };

  // é–‹/é—œ
  openBtn.addEventListener('click', open);
  closeBtn.addEventListener('click', close);
  modal.addEventListener('click', (e) => { if (e.target === modal) close(); });

  // é»æœå°‹
  btn.addEventListener('click', () => doSearch());

  // Enter æœå°‹
  input.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      doSearch();
    }
    if (e.key === 'Escape') close();
  });

  // é»ç†±é–€ tag
  hotWrap?.addEventListener('click', (e) => {
    const tag = e.target.closest('.hot-tag');
    if (!tag) return;
    doSearch(tag.dataset.q || tag.textContent);
  });

  // (å¯é¸) æ‰“é–‹ modal æ™‚ï¼ŒæŠŠç›®å‰ kw å¸¶é€²å»
  openBtn.addEventListener('click', () => {
    input.value = kw.value || '';
  });
})();
</script>

<script>
(() => {
  const moreToggle = document.getElementById('more-toggle');
  if (!moreToggle) return;

  const sync = () => {
    document.body.classList.toggle('is-more-open', moreToggle.checked);
  };

  moreToggle.addEventListener('change', sync);
  sync();
})();
</script>

<script src="cart_store.js"></script>
<script src="nav_more_full.js"></script>
<script src="cart_page.js"></script>
<script src="cart_deeplink.js"></script>

</body>
</html>
